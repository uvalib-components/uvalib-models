<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../uvalib-helper-libs/uvalib-helper-libs.html">
<link rel="import" href="uvalib-model-weeks.html">

<!--
`uvalib-model-library`
data model for days in a week for a library location.

@demo demo/library.html
-->

<dom-module id="uvalib-model-days">
  <template>
    <template is="dom-if" if="{{!object}}" restamp>
      <uvalib-model-weeks lid="[[lid]]" library="[[library]]" start-week="{{weekNumber}}" num-weeks="1" name="{{_name}}" category="{{_category}}" description="{{_description}}" contact="{{_contact}}" data="{{_data}}"/>
    </template>
  </template>

  <script>
    Polymer({

      is: 'uvalib-model-days',

      properties: {
        /**
         * The library that is being requested.  If the lid property is not specified and the library property is, then this is used to define which Library is being requested.
         */
        library: {
          value: null,
          type: String,
          notify: true
        },
        /**
         * The Springshare LibCal library identifier. If specified will define which Library is being requested (takes priority over the library property)
         */
        lid: {
          value: null,
          type: String,
          notify: true
        },
        /**
         * Retrieves information for today's date.
         */
        today: {
          value: false,
          type: Boolean,
          notify: true
        },
        /**
         * Number of minutes before and after open hours for adding soon to Open/Closed status.
         */
        soonTime: {
          value: 30,
          type: Number,
          notify: true
        },
        /**
         * Which week to retrieve. An integer value between 1 and 52.
         * Note: Week 1 represents the current week and the LibCal API provides data out to a max of 52 weeks.
         */
        weekNumber: {
          value: 1,
          type: Number,
          notify: true
        },
        /**
         * A week object containing an array as it is represented from the API.  If this property is set, the object provided is parsed and used, otherwise this is populated from the API request.
         */
        object: {
          value: null,
          type: Object,
          notify: true
        },
        data: {
          type: Array,
          computed: '_processList(object)',
          notify: true,
          readOnly: true
        },
        _data: {
          value: null,
          type: Array,
          observer: "_dataChanged"
        },
        /**
         * The Springshare name of the Library location.
         */
        name: {
          value: "",
          type: String,
          notify: true
        },
        _name: {
          type: String,
          observer: "_nameChanged",
        },
        /**
         * Springshare library location category.
         */
        category: {
          value: "",
          type: String,
          notify: true
        },
        _category: {
          type: String,
          observer: "_categoryChanged",
        },
        /**
         * Springshare library location description.
         */
        description: {
          value: "",
          type: String,
          notify: true
        },
        _description: {
          type: String,
          observer: "_descriptionChanged",
        },
        /**
         * Springshare library location contact information.
         */
        contact: {
          value: "",
          type: String,
          notify: true
        },
        _contact: {
          type: String,
          observer: "_contactChanged",
        },
      },

      _dataChanged: function(){
        if (this._data && this._data.length > 0) {
          this.object = this._data;
        }
      },

      _processList: function(obj){
        if (obj) {
          var data = obj;
          var today = moment().format("YYYY-MM-DD");
          console.log("today is ", today);
          var day;
          for (day in data[0]) {
            if (data[0][day].date == today) {
              data[0][day]["isToday"] = true;
              data[0][day]["currentStatus"] = this._currentStatus(data[0][day].times.hours[0].from,data[0][day].times.hours[0].to);
            } else {
              data[0][day]["isToday"] = false;
              data[0][day]["currentStatus"] = "";
            }
          }
          if (this.today) {
            var _oneday = Array();
            for (day in data[0]) {
              if (data[0][day].date == today) {
                _oneday[0] = data[0][day];
                break;
              }
            }
            return _oneday;
          } else {
            return data;
          }
        } else return null;
      },

      _nameChanged: function(){
        if (this._name) {
          this.name = this._name;
        }
      },
      _categoryChanged: function() {
        if (this._category) {
          this.category = this._category;
        }
      },
      _descriptionChanged: function() {
        if (this._description) {
          this.description = this._description;
        }
      },
      _contactChanged: function() {
        if (this._contact) {
          this.contact = this._contact;
        }
      },

      _currentStatus: function(openTime,closeTime) {
        console.log("currentStatus");
        var status = '';
        var opening = (openTime.includes(":")) ? moment(openTime, "h:mma") : moment(openTime, "ha");
        var closing = (closeTime.includes(":")) ? moment(closeTime, "h:mma") : moment(closeTime, "ha");
        console.log("opening time: ", opening);
        console.log("closing time: ", closing);
        if (opening.isAfter(moment()) && opening.subtract(this.soonTime, 'minutes').isBefore(moment())) {
          console.log('opening.isafter: ' + opening.isAfter(moment()));
          status = "Opening soon";
        } else if (closing.isAfter(moment()) && closing.subtract(this.soonTime, 'minutes').isBefore(moment())) {
          console.log('closing.isafter: ' + closing.isAfter(moment()));
          status = "Closing soon";
        } else if (opening.isBefore(moment()) && closing.isAfter(moment())) {
          console.log('opening.isbefore: ' + opening.isBefore(moment()));
          console.log('closing.isafter: ' + closing.isAfter(moment()));
          status = "Open";
        } else if (closing.isBefore(moment())) {
          console.log('closing.isbefore: ' + closing.isBefore(moment()));
          status = "Closed";
        }
        return status;
      }
    });
  </script>
</dom-module>
